<?php

require_once '../vendor/autoload.php';

$payload = [];

// Uncomment the line below to get a mock response back
//die('{"data":{"name":"Bruno Skvorc","plan":"custom","calls":{"2016-01-17":0,"2016-01-16":0,"2016-01-15":0,"2016-01-14":0,"2016-01-13":0,"2016-01-12":0,"2016-01-11":0,"2016-01-10":0,"2016-01-09":0,"2016-01-08":0,"2016-01-07":0,"2016-01-06":0,"2016-01-05":0,"2016-01-04":0,"2016-01-03":0,"2016-01-02":0,"2016-01-01":0,"2015-12-31":0,"2015-12-30":0,"2015-12-29":0,"2015-12-28":2,"2015-12-27":0,"2015-12-26":0,"2015-12-25":0,"2015-12-24":0,"2015-12-23":0,"2015-12-22":0,"2015-12-21":0,"2015-12-20":0,"2015-12-19":0,"2015-12-18":0,"2015-12-17":0,"2015-12-16":0,"2015-12-15":0,"2015-12-14":0,"2015-12-13":0,"2015-12-12":0,"2015-12-11":1,"2015-12-10":0,"2015-12-09":6,"2015-12-08":0,"2015-12-07":0,"2015-12-06":0,"2015-12-05":0,"2015-12-04":0,"2015-12-03":0,"2015-12-02":0,"2015-12-01":0,"2015-11-30":0,"2015-11-29":2,"2015-11-28":0,"2015-11-27":0,"2015-11-26":0,"2015-11-25":0,"2015-11-24":0,"2015-11-23":0,"2015-11-22":0,"2015-11-21":0,"2015-11-20":0,"2015-11-19":0,"2015-11-18":0,"2015-11-17":0,"2015-11-16":0,"2015-11-15":0,"2015-11-14":0,"2015-11-13":0,"2015-11-12":0,"2015-11-11":0,"2015-11-10":0,"2015-11-09":0,"2015-11-08":3,"2015-11-07":2,"2015-11-06":0,"2015-11-05":0,"2015-11-04":0,"2015-11-03":0,"2015-11-02":0,"2015-11-01":7,"2015-10-31":2,"2015-10-30":0,"2015-10-29":0,"2015-10-28":0,"2015-10-27":0,"2015-10-26":0,"2015-10-25":1,"2015-10-24":3,"2015-10-23":0,"2015-10-22":0,"2015-10-21":0,"2015-10-20":0,"2015-10-19":0,"2015-10-18":2,"2015-10-17":9,"2015-10-16":0,"2015-10-15":0,"2015-10-14":144,"2015-10-13":31,"2015-10-12":0,"2015-10-11":0,"2015-10-10":0,"2015-10-09":0,"2015-10-08":1,"2015-10-07":1,"2015-10-06":1,"2015-10-05":39,"2015-10-04":6,"2015-10-03":0,"2015-10-02":0,"2015-10-01":2,"2015-09-30":0,"2015-09-29":7,"2015-09-28":0,"2015-09-27":0,"2015-09-26":1,"2015-09-25":34,"2015-09-24":0,"2015-09-23":0,"2015-09-22":0,"2015-09-21":0,"2015-09-20":3,"2015-09-19":0,"2015-09-18":0,"2015-09-17":0,"2015-09-16":0,"2015-09-15":0,"2015-09-14":0,"2015-09-13":0,"2015-09-12":0,"2015-09-11":0,"2015-09-10":3,"2015-09-09":0,"2015-09-08":0,"2015-09-07":0,"2015-09-06":0,"2015-09-05":0,"2015-09-04":0,"2015-09-03":0,"2015-09-02":0,"2015-09-01":2,"2015-08-31":0,"2015-08-30":0,"2015-08-29":0,"2015-08-28":0,"2015-08-27":0,"2015-08-26":0,"2015-08-25":1,"2015-08-24":0,"2015-08-23":0,"2015-08-22":0,"2015-08-21":0,"2015-08-20":0,"2015-08-19":1,"2015-08-18":0,"2015-08-17":0,"2015-08-16":2,"2015-08-15":0,"2015-08-14":0,"2015-08-13":0,"2015-08-12":5,"2015-08-11":1,"2015-08-10":0,"2015-08-09":0,"2015-08-08":0,"2015-08-07":0,"2015-08-06":0,"2015-08-05":1,"2015-08-04":0,"2015-08-03":0,"2015-08-02":0,"2015-08-01":0,"2015-07-31":6,"2015-07-30":0,"2015-07-29":8,"2015-07-28":1,"2015-07-27":5,"2015-07-26":3,"2015-07-25":3,"2015-07-24":2,"2015-07-23":6,"2015-07-22":1,"2015-07-21":1,"2015-07-20":3,"2015-07-19":27,"2015-07-18":9,"2015-07-17":1,"2015-07-16":1,"2015-07-15":1,"2015-07-14":11,"2015-07-13":11,"2015-07-12":0,"2015-07-11":57,"2015-07-10":0,"2015-07-09":0,"2015-07-08":0,"2015-07-07":28,"2015-07-06":0,"2015-07-05":2,"2015-07-04":1,"2015-07-03":19,"2015-07-02":168,"2015-07-01":4,"2015-06-30":8,"2015-06-29":7,"2015-06-28":7,"2015-06-27":2,"2015-06-26":7,"2015-06-25":5,"2015-06-24":55,"2015-06-23":284,"2015-06-22":12,"2015-06-21":13,"2015-06-20":7,"2015-06-19":9,"2015-06-18":9,"2015-06-17":57,"2015-06-16":19,"2015-06-15":208,"2015-06-14":2174,"2015-06-13":7436,"2015-06-12":10962,"2015-06-11":7339,"2015-06-10":0,"2015-06-09":0,"2015-06-08":0,"2015-06-07":0,"2015-06-06":1,"2015-06-05":0,"2015-06-04":0,"2015-06-03":0,"2015-06-02":0,"2015-06-01":0,"2015-05-31":0,"2015-05-30":0,"2015-05-29":0,"2015-05-28":0,"2015-05-27":0,"2015-05-26":0,"2015-05-25":0,"2015-05-24":0,"2015-05-23":0,"2015-05-22":0,"2015-05-21":37788,"2015-05-20":92219,"2015-05-19":58691,"2015-05-18":0,"2015-05-17":91573,"2015-05-16":0,"2015-05-15":0,"2015-05-14":0,"2015-05-13":0,"2015-05-12":0,"2015-05-11":0,"2015-05-10":0,"2015-05-09":0,"2015-05-08":0,"2015-05-07":0,"2015-05-06":0,"2015-05-05":0,"2015-05-04":0,"2015-05-03":49,"2015-05-02":8,"2015-05-01":60,"2015-04-30":0,"2015-04-29":0,"2015-04-28":0,"2015-04-27":0,"2015-04-26":0,"2015-04-25":0,"2015-04-24":0,"2015-04-23":0,"2015-04-22":0,"2015-04-21":0,"2015-04-20":0,"2015-04-19":26,"2015-04-18":0,"2015-04-17":0,"2015-04-16":0,"2015-04-15":0,"2015-04-14":0,"2015-04-13":2,"2015-04-12":52,"2015-04-11":0,"2015-04-10":0,"2015-04-09":0,"2015-04-08":0,"2015-04-07":0,"2015-04-06":0,"2015-04-05":0,"2015-04-04":0,"2015-04-03":0,"2015-04-02":0,"2015-04-01":0,"2015-03-31":0,"2015-03-30":10,"2015-03-29":22,"2015-03-28":0,"2015-03-27":0,"2015-03-26":0,"2015-03-25":0,"2015-03-24":0,"2015-03-23":0,"2015-03-22":0,"2015-03-21":0,"2015-03-20":0,"2015-03-19":0,"2015-03-18":0,"2015-03-17":0,"2015-03-16":0,"2015-03-15":7,"2015-03-14":0,"2015-03-13":0,"2015-03-12":0,"2015-03-11":0,"2015-03-10":0,"2015-03-09":0,"2015-03-08":0,"2015-03-07":0,"2015-03-06":0,"2015-03-05":0,"2015-03-04":0,"2015-03-03":0,"2015-03-02":0,"2015-03-01":0,"2015-02-28":0,"2015-02-27":0,"2015-02-26":0,"2015-02-25":0,"2015-02-24":0,"2015-02-23":0,"2015-02-22":0,"2015-02-21":0,"2015-02-20":0,"2015-02-19":2,"2015-02-18":2,"2015-02-17":2,"2015-02-16":2,"2015-02-15":0,"2015-02-14":0,"2015-02-13":0,"2015-02-12":3,"2015-02-11":0,"2015-02-10":0,"2015-02-09":0,"2015-02-08":4,"2015-02-07":2,"2015-02-06":0,"2015-02-05":4,"2015-02-04":0,"2015-02-03":42,"2015-02-02":2,"2015-02-01":14,"2015-01-31":0,"2015-01-30":1,"2015-01-29":0,"2015-01-28":0,"2015-01-27":0,"2015-01-26":1,"2015-01-25":0,"2015-01-24":0,"2015-01-23":4,"2015-01-22":0,"2015-01-21":0,"2015-01-20":0,"2015-01-19":0,"2015-01-18":0,"2015-01-17":0,"2015-01-16":0,"2015-01-15":0,"2015-01-14":0,"2015-01-13":0,"2015-01-12":0,"2015-01-11":0,"2015-01-10":0,"2015-01-09":0,"2015-01-08":0,"2015-01-07":0,"2015-01-06":0,"2015-01-05":0,"2015-01-04":0,"2015-01-03":0,"2015-01-02":0,"2015-01-01":0},"invoices":[{"date":{"date":"2015-11-02 00:00:00.000000","timezone_type":2,"timezone":"GMT"},"totalCalls":105031,"totalAmount":299,"plan":"Startup","periodStart":"2015-10-02","overageAmount":0,"status":"paid","periodEnd":"2015-11-02"},{"date":{"date":"2015-10-02 00:00:00.000000","timezone_type":2,"timezone":"GMT"},"totalCalls":41212,"totalAmount":299,"plan":"Startup","periodStart":"2015-09-02","overageAmount":0,"status":"paid","periodEnd":"2015-10-02"},{"date":{"date":"2015-11-02 00:00:00.000000","timezone_type":2,"timezone":"GMT"},"totalCalls":105031,"totalAmount":299,"plan":"Startup","periodStart":"2015-10-02","overageAmount":950,"status":"foo","periodEnd":"2015-11-02"},{"date":{"date":"2015-10-02 00:00:00.000000","timezone_type":2,"timezone":"GMT"},"totalCalls":41212,"totalAmount":299,"plan":"Startup","periodStart":"2015-09-02","overageAmount":0,"status":"paid","periodEnd":"2015-10-02"},{"date":{"date":"2015-11-02 00:00:00.000000","timezone_type":2,"timezone":"GMT"},"totalCalls":105031,"totalAmount":299,"plan":"Startup","periodStart":"2015-10-02","overageAmount":0,"status":"paid","periodEnd":"2015-11-02"},{"date":{"date":"2015-10-02 00:00:00.000000","timezone_type":2,"timezone":"GMT"},"totalCalls":41212,"totalAmount":299,"plan":"Startup","periodStart":"2015-09-02","overageAmount":0,"status":"paid","periodEnd":"2015-10-02"},{"date":{"date":"2015-11-02 00:00:00.000000","timezone_type":2,"timezone":"GMT"},"totalCalls":105031,"totalAmount":299,"plan":"Startup","periodStart":"2015-10-02","overageAmount":0,"status":"paid","periodEnd":"2015-11-02"},{"date":{"date":"2015-10-02 00:00:00.000000","timezone_type":2,"timezone":"GMT"},"totalCalls":41212,"totalAmount":299,"plan":"Startup","periodStart":"2015-09-02","overageAmount":0,"status":"paid","periodEnd":"2015-10-02"}],"range":{"from":"2015-01-01","to":"2016-01-17"}},"status":"OK"}');

try {
    $diffbot = new Swader\Diffbot\Diffbot($_GET['token']);
    $days = (isset($_GET['days']) && (int)$_GET['days'] > 31) ? (int)$_GET['days'] : 31;
    $info = $diffbot->getAccountInfo($days);

    $cpd = $info->getCallsPerDay();
    $keys = array_keys($cpd);
    $to = key($cpd);
    $from = array_pop($keys);

    $invoices = $info->getInvoices();
    if ($invoices) {
        // Fake overage
        $invoices = array_merge($invoices, $invoices, $invoices, $invoices);
        foreach ($invoices as &$invoice) {
            if (rand(1, 20) > 15) {
                $invoice['overageAmount'] = rand(1, 1000);
                $invoice['status'] = 'foo';
            }
        }
    }

    $payload = [
        "data" => [
            'name' => $info->getName(),
            'plan' => $info->getPlan(),
            'calls' => $cpd,
            'invoices' => $invoices,
            'range' => [
                'from' => $from,
                'to' => $to
            ]
        ],
        "status" => "OK"
    ];
} catch (\Exception $e) {
    $payload = [
        "status" => "error",
        "message" => $e->getMessage(),
        "code" => $e->getCode()
    ];
}

die(json_encode($payload));